#!/bin/bash

#
# Fan control script for ASUS laptops using asus-nb-wmi driver
#
# Usage: fan-control {silent|balanced|performance}
#
# It sets predefined fan speed curves for CPU and GPU based on the selected mode.
# It requires write permissions to the hwmon interface, which may need sudo privileges or appropriate rules to allow non-root access.
#
# The privileges can be granted with an /etc/tmpfiles.d/asus_fan_perms.conf with the following content:
: '
# PWM1 and PWM2 auto points and temp files (any hwmon*)
z /sys/devices/platform/asus-nb-wmi/hwmon/hwmon*/pwm*_auto_point*_pwm 664 root yourusername - -
z /sys/devices/platform/asus-nb-wmi/hwmon/hwmon*/pwm*_auto_point*_temp 664 root yourusername - -

# PWM1 and PWM2 enable files
z /sys/devices/platform/asus-nb-wmi/hwmon/hwmon*/pwm*_enable 664 root yourusername - -
'

HWMON_PATH=""
MODE="$1"

# Find the correct hwmon path for asus_custom_fan_curve
for d in /sys/devices/platform/asus-nb-wmi/hwmon/hwmon*/; do
    if [ "$(cat "$d/name")" = "asus_custom_fan_curve" ]; then
        HWMON_PATH="$d"
        break
    fi
done

# exit if hwmon path not found
if [ -z "$HWMON_PATH" ]; then
    echo "Error: asus_custom_fan_curve hwmon device not found."
    exit 1
fi

echo "Found device at: $HWMON_PATH"

case "$MODE" in
    silent)
        echo "Setting silent fan mode..."
        CPU_FAN_CURVE_POINTS=( "40:15" "47:25" "54:40" "61:60" "68:85" "74:110" "80:140" "85:170" )
        GPU_FAN_CURVE_POINTS=( "40:17" "47:28" "54:44" "61:66" "68:93" "74:121" "80:154" "85:187" )
        ;;
    balanced)
        echo "Setting balanced fan mode..."
        CPU_FAN_CURVE_POINTS=( "40:15" "47:30" "54:50" "61:75" "68:100" "74:130" "80:160" "85:190" )
        GPU_FAN_CURVE_POINTS=( "40:17" "47:33" "54:55" "61:83" "68:110" "74:143" "80:176" "85:209" )
        ;;
    performance)
        echo "Setting performance fan mode..."
        CPU_FAN_CURVE_POINTS=( "40:15" "47:35" "54:65" "61:95" "68:125" "74:160" "80:190" "85:210" )
        GPU_FAN_CURVE_POINTS=( "40:17" "47:39" "54:72" "61:105" "68:138" "74:176" "80:209" "85:231" )
        ;;
    *)
        echo "Usage: fan-control {silent|balanced|performance}"
        exit 1
        ;;
esac

for i in {0..7}; do
    # Split temperature:pwm
    IFS=':' read -r cpu_temp cpu_pwm <<< "${CPU_FAN_CURVE_POINTS[$i]}"
    IFS=':' read -r gpu_temp gpu_pwm <<< "${GPU_FAN_CURVE_POINTS[$i]}"

    echo "$cpu_temp" > "$HWMON_PATH/pwm1_auto_point$((i+1))_temp"
    echo "$cpu_pwm" > "$HWMON_PATH/pwm1_auto_point$((i+1))_pwm"
    echo "$gpu_temp" > "$HWMON_PATH/pwm2_auto_point$((i+1))_temp"
    echo "$gpu_pwm" > "$HWMON_PATH/pwm2_auto_point$((i+1))_pwm"
done
echo 1 > "$HWMON_PATH"/pwm1_enable
echo 1 > "$HWMON_PATH"/pwm2_enable

